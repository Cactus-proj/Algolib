# Copyright (C) 1991--2010 by INRIA.
#
# This file is part of Algolib.
#
# Algolib is free software: you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# Algolib is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with Algolib.  If not, see
# <http://www.gnu.org/licenses/>.

# Due to known non-determinism in Maple, the signs of several results
# in the following may vary without contradicting the specifications
# of the procedure that compute them.  We thus need the following
# procedure for comparison up to signs.
cmp:=proc(a,b) testeq(a,b) or testeq(a,-b) end:

with(Ore_algebra):
with(Groebner):
with(Holonomy):
with(Mgfun):

# Section 1.1. Examples of Ore algebras
# Declaration of the Weyl algebra
# Q[x[1],x[2],x[3]][Dx[1];1,Dx[1]][Dx[2];1,Dx[2]][Dx[3];1,Dx[3]]
A:=diff_algebra([Dx[1],x[1]],[Dx[2],x[2]],[Dx[3],x[3]]):
# Jacobi polynomials
A:=skew_algebra(comm=[a,b],shift=[Sn,n],diff=[Dx,x],polynom={n,x}):
G:=[2*(n+2)*(n+a+b+2)*(2*n+a+b+2)*Sn^2
        -((2*n+a+b+3)*(a^2-b^2)+(2*n+a+b+2)
            *(2*n+a+b+3)*(2*n+a+b+4)*x)*Sn
        +2*(n+a+1)*(n+b+1)*(2*n+a+b+4),
    (2*n+a+b+2)*(1-x^2)*Dx*Sn-(n+1)
        *(a-b-(2*n+a+b+2)*x)*Sn-2*(n+a+1)*(n+b+1)]:
eval(map(applyopr,G,P(n,a,b,x),A)):
normal(eval(subs({
    n=4,
    P(n,a,b,x)=orthopoly[P](4,a,b,x),
    P(n+1,a,b,x)=orthopoly[P](5,a,b,x),
    P(n+2,a,b,x)=orthopoly[P](6,a,b,x),
    D[4](P)(n+1,a,b,x)=diff(orthopoly[P](5,a,b,x),x)
},%))):
if %=[0,0] then okay else % fi;
# First example of q-calculus
A:=skew_algebra(`shift+qshift`=[Sn,q^n]):
factor(skew_product(Sn,n^3*(q^n)^7,A)):
if %=(n+1)^3*q^7*(q^n)^7*Sn then okay else % fi;
expand(expand(applyopr(Sn-(n+1)*q*(q^n)^2,n!*q^(n^2),A))):
if %=0 then okay else % fi;
# Second example of q-calculus
A:=skew_algebra(qshift=[Sk,q^k],qdiff=[Hqz,z,q]):
combine(subs((q*z)^k=q^k*z^k,expand(
    map(applyopr,{Sk-z*q^k,(q-1)*z*Hqz-q^k+1},q^binomial(k,2)*z^k,A))),
	power,symbolic):
if %={0} then okay else % fi;
# BUG: BAD SYSTEM IN THE PAPER!

# Section 1.4.1. Jacobi polynomials
A:=skew_algebra(comm=[a,b],shift=[Sn,n],diff=[Dx,x]):
G:=[2*(n+2)*(n+a+b+2)*(2*n+a+b+2)*Sn^2
        -((2*n+a+b+3)*(a^2-b^2)+(2*n+a+b+2)
            *(2*n+a+b+3)*(2*n+a+b+4)*x)*Sn
        +2*(n+a+1)*(n+b+1)*(2*n+a+b+4),
    (2*n+a+b+2)*(1-x^2)*Dx*Sn-(n+1)
        *(a-b-(2*n+a+b+2)*x)*Sn-2*(n+a+1)*(n+b+1)]:
skew_elim(G[1],G[2],Sn,A):
if %=-n*a-n-n*b-n^2+Dx*x*a+2*Dx*x+Dx*x*b+Dx*a-Dx*b+Dx^2*x^2-Dx^2
then okay else % fi;

# Section 1.4.2. Gauss's hypergeometric function
A:=skew_algebra(comm=[b,c],diff=[Dz,z],shift=[Sa,a]):
P:=z*(1-z)*Dz^2+(c-(a+b+1)*z)*Dz-a*b:
H:=a*Sa-(z*Dz+a):
skew_elim(P,H,Dz,A):
if %=a+a*Sa^2-2*a*Sa+z*a*Sa-z*a*Sa^2-c+1-z*Sa^2-z*b*Sa+Sa*c-2*Sa+Sa^2+z*Sa
then okay else % fi;
A:=skew_algebra(comm=[a,b,c],diff=[Dz,z]):
GCD:=skew_gcdex(P,z*Dz+a,Dz,A):
collect((a-1)*subs(a=a-1,GCD[3]/GCD[1]),Dz,factor):
if %=z*(-1+z)/(a-c)*Dz+(z*b-c+a)/(a-c) then okay else % fi;

# Section 1.4.3. Partially hypergeometric series
A:=shift_algebra([Sn,n],[Sk,k],[comm,z]):
h:=(-1)^k*binomial(n,k)^2*binomial(n+k,k)^2:
G:=numer(normal({Sn-subs(n=n+1,h)/h,Sk-subs(k=k+1,h)/h},expanded)):
G:=collect(G,{Sn,Sk},factor):
op(select(has,G,Sk)):
if normal(Sk*(k+1)^4+(n+1+k)^2*(n-k)^2-%)=0 then okay else % fi;
# You can run this if you have gfun in the share library.
#
#with(share):
#readshare(gfun,analysis):
#with(gfun):
#applyopr(L,u(k),A);
#rectodiffeq({%},u(k),f(z));
#M:=collect(subs({seq((D@@i)(f)(z)=Dz^i,i=0..4)},%),Dz,factor);
#
# Otherwise, here is the result.
M:=z^3*(z+1)*Dz^4+2*z^2*(4*z+3)*Dz^3-z*(-14*z+2*z*n+2*z*n^2-7)*Dz^2
    +(-4*z*n^2+4*z-4*z*n+1)*Dz+(n+1)^2*n^2:
H:=Sn:
# Naive method that returns an operator of order 7.
normal(applyopr(H,h,A)/h,expanded):
P:=numer(%): Q:=denom(%%):
A:=skew_algebra(diff=[Dz,z],shift=[Sn,n]):
P2:=collect(subs({seq(k^i=skew_power(z*Dz,i,A),
    i=1..degree(P,k))},P),Dz,factor):
Q2:=collect(subs({seq(k^i=skew_power(z*Dz,i,A),
    i=1..degree(Q,k))},Q),Dz,factor):
collect(Q2*H-P2,{Dz,Sn},distributed,factor):
# The contiguity relation of order 7 is:
collect(skew_elim(%,M,Dz,A),Sn,factor):
if %=
-(2*n+5)*(2*n+3)*(n+3)*(2*n+7)*(n+6)^2*(n+7)^4*(80*z*n^6+16*n^6+64*z^2*n^6+336
*n^5+1344*z^2*n^5+1680*n^5*z+14024*z*n^4+11068*z^2*n^4+2812*n^4+59136*z*n^3+
11928*n^3+45192*z^2*n^3+26929*n^2+95317*z^2*n^2+132146*z*n^2+148470*z*n+97839*
z^2*n+30723*n+65892*z+13926+37926*z^2)*Sn^7-(2*n+5)*(2*n+3)*(n+3)*(2*n+13)*(n+
6)^2*(-94980*n^8-237936*z*n^7-1157982*z*n^6-267188865*n-343911303*n^2-4912*n^9
+1942323726*z^2-118027892*n^4-253024934*n^3+1854108*n^8*z^2+35742924*z-7634895
*n^6+2167153888*z^3*n^4-112*n^10+1260508536*z^3-1064208*n^7+5308699674*z^2*n^3
+2446159284*z^2*n^4+21778944*z*n^3+5719229619*z^2*n+7294149117*z^2*n^2-48*n^10
*z+153854757*z^2*n^6-1776*n^9*z+2112*z^2*n^10+94272*z^2*n^9+74932194*z*n+
61213146*z*n^2+747533139*z^2*n^5+684014160*z^3*n^5+2048*n^10*z^3+91136*n^9*z^3
+5805308712*z^3*n^2-36558969*n^5+217344*z*n^4+4496164156*z^3*n^3-2810946*n^5*z
+144030240*n^6*z^3+1781376*n^8*z^3+20079744*n^7*z^3+21115680*n^7*z^2-27864*n^8
*z+4178435604*z^3*n-90076386)*Sn^6-(2*n+5)*(2*n+3)*(2*n+11)*(648860962*n^8+
38728426434*z*n^7+159600076920*z*n^6+190570480448*z^4*n^7+4862476649552*z^4*n^
4+85986404676*n+142476377942*n^2+19392*n^12+336*n^13+86013981*n^9+
1240168995240*z^2+92611050594*n^4+140759325855*n^3+29689194154*n^8*z^2+
282250162032*z+509884*n^11+14420346306*n^6+4004292023424*z^4*n+8838498205900*z
^3*n^4+8079996*n^10+23350952808+2200064944896*z^3+16384*n^13*z^4+3564500133*n^
7+7214712213739*z^2*n^3+4661946810770*z^2*n^4+1637039252154*z*n^3+
4528595526708*z^2*n+7414419736502*z^2*n^2+25930752*z^4*n^11+5104760*n^11*z+
7022713614000*z^4*n^2+82653816*n^10*z+694980071674*z^2*n^6+898404042*n^9*z+
348550828*z^2*n^10+3824465873*z^2*n^9+1027535345112*z*n+1680767812396*z*n^2+
2115800273987*z^2*n^5+4053512450028*z^3*n^5+693507584*n^10*z^3+7559783776*n^9*
z^3+42668928*n^11*z^3+7210521226000*z^4*n^3+966656*z^4*n^12+13682650948296*z^3
*n^2+42906452495*n^5+34459329792*z^4*n^8+2284329208368*z^4*n^5+1002247646400*z
^4+1060559347776*z*n^4+771940158784*z^4*n^6+13120*z^2*n^13+783872*z^2*n^12+
26624*z^3*n^13+1580032*z^3*n^12+3216*n^13*z+189888*n^12*z+13511037661940*z^3*n
^3+418210816*z^4*n^10+483287935450*n^5*z+21306988*n^11*z^2+1343604801980*n^6*z
^3+58286832432*n^8*z^3+326533490992*n^7*z^3+4517690624*z^4*n^9+167545606625*n^
7*z^2+6914943860*n^8*z+8210026188432*z^3*n)*Sn^5+(2*n+9)*(2*n+3)*(2*n+13)*(
670104558*n^8+62787989214*z*n^7+232646448964*z*n^6+297655968192*z^4*n^7+
5546371391664*z^4*n^4+46053809388*n+83182050706*n^2+29440*n^12+560*n^13+
11523220920+97936163*n^9+1160209491000*z^2+64925778266*n^4+89917367765*n^3+
63547672678*n^8*z^2+231596949360*z+704100*n^11+12249111378*n^6+3476991692160*z
^4*n+10987462278952*z^3*n^4+10136540*n^10+1866003515040*z^3+49152*n^13*z^4+
3338131859*n^7+8926613181009*z^2*n^3+6396147845746*z^2*n^4+1758422210082*z*n^3
+4623878113500*z^2*n+8311331715330*z^2*n^2+62702592*z^4*n^11+12756616*n^11*z+
6631955306064*z^4*n^2+185331192*n^10*z+1185181654754*z^2*n^6+1807328726*n^9*z+
941280204*z^2*n^10+9191040175*z^2*n^9+917574777528*z*n+1642199836716*z*n^2+
3231341124665*z^2*n^5+5603671818176*z^3*n^5+1675034624*n^10*z^3+16305338944*n^
9*z^3+115392256*n^11*z^3+7461641061744*z^4*n^3+2605056*z^4*n^12+13910092243648
*z^3*n^2+33085521973*n^5+60008279808*z^4*n^8+2884936058448*z^4*n^5+
807866136000*z^4+1257462926348*z*n^4+1082954631744*z^4*n^6+50368*z^2*n^13+
2676224*z^2*n^12+90112*z^3*n^13+4782080*z^3*n^12+9968*n^13*z+528640*n^12*z+
15156416516288*z^3*n^3+906654720*z^4*n^10+634562643130*n^5*z+64691060*n^11*z^2
+2071109198296*n^6*z^3+112293555296*n^8*z^3+562342435424*n^7*z^3+8777472768*z^
4*n^9+319814508279*n^7*z^2+12483737564*n^8*z+7602320946336*z^3*n)*Sn^4-(2*n+7)
*(2*n+3)*(2*n+13)*(596796138*n^8+48624025054*z*n^7+172031841612*z*n^6+
232808309184*z^4*n^7+3829409246160*z^4*n^4+34497078156*n+63836711782*n^2+28800
*n^12+560*n^13+89361763*n^9+610197447720*z^2+52351911278*n^4+70724042517*n^3+
50463545810*n^8*z^2+127804460880*z+673380*n^11+10382799574*n^6+2151373929600*z
^4*n+7363953429720*z^3*n^4+9471620*n^10+1052358864480*z^3+49152*n^13*z^4+
2900711699*n^7+5499248038545*z^2*n^3+4150173636854*z^2*n^4+1126781871522*z*n^3
+2564826281340*z^2*n+4859515283350*z^2*n^2+57984000*z^4*n^11+11767432*n^11*z+
4245061542960*z^4*n^2+163909832*n^10*z+851895678246*z^2*n^6+1530795606*n^9*z+
822649876*z^2*n^10+7661023215*z^2*n^9+532621021560*z*n+1001893454084*z*n^2+
2207367226009*z^2*n^5+3930740514624*z^3*n^5+1475258368*n^10*z^3+13735426624*n^
9*z^3+106151680*n^11*z^3+4954911455088*z^4*n^3+2506752*z^4*n^12+8531414872896*
z^3*n^2+27352736917*n^5+48974588160*z^4*n^8+2074421627472*z^4*n^5+484905960000
*z^4+845762274820*z*n^4+811887892416*z^4*n^6+50368*z^2*n^13+2562048*z^2*n^12+
90112*z^3*n^13+4589568*z^3*n^12+9968*n^13*z+508032*n^12*z+9712518187968*z^3*n^
3+804842496*z^4*n^10+447680623994*n^5*z+59210612*n^11*z^2+1521125868328*n^6*z^
3+90406827424*n^8*z^3+432470082144*n^7*z^3+7473224448*z^4*n^9+241721896055*n^7
*z^2+10115487316*n^8*z+4468121065632*z^3*n+8428824360)*Sn^3+(2*n+5)*(2*n+13)*(
2*n+11)*(201021446*n^8+6507045058*z*n^7+19278024184*z*n^6+32398803776*z^4*n^7+
315535254320*z^4*n^4+4434266916*n+9462409362*n^2+15552*n^12+336*n^13+34114141*
n^9+6911840376*z^2+10297384054*n^4+12083336671*n^3+5846250782*n^8*z^2+
3989481552*z+325564*n^11+2689603670*n^6+104050800000*z^4*n+484252867348*z^3*n^
4+4079140*n^10+29438640000*z^3+16384*n^13*z^4+858452261*n^7+194646861355*z^2*n
^3+194504508774*z^2*n^4+70073637818*z*n^3+45826603284*z^2*n+125422522194*z^2*n
^2+14920704*z^4*n^11+2929784*n^11*z+244498146000*z^4*n^2+35403464*n^10*z+
65065622078*z^2*n^6+284375882*n^9*z+136576628*z^2*n^10+1069412113*z^2*n^9+
21208829592*z*n+50161182276*z*n^2+133451236003*z^2*n^5+315665832108*z^3*n^5+
285908480*n^10*z^3+2271110496*n^9*z^3+23892864*n^11*z^3+341168970000*z^4*n^3+
939708216+737280*z^4*n^12+369397670424*z^3*n^2+6182227951*n^5+8035664640*z^4*n
^8+204293021232*z^4*n^5+19845000000*z^4+64633238480*z*n^4+95267825856*z^4*n^6+
13120*z^2*n^13+580608*z^2*n^12+26624*z^3*n^13+1188864*z^3*n^12+3216*n^13*z+
144576*n^12*z+519696090996*z^3*n^3+179682304*z^4*n^10+41624849882*n^5*z+
11550316*n^11*z^2+148124954820*n^6*z^3+12638717904*n^8*z^3+50670026032*n^7*z^3
+1435778304*z^4*n^9+22915448929*n^7*z^2+1602053980*n^8*z+155812968720*z^3*n)*
Sn^2+(2*n+11)*(2*n+3)*(n+5)*(2*n+13)*(n+2)^2*(-63876*n^8-402576*z*n^7-2671326*
z*n^6-35950959*n-58553847*n^2-4048*n^9+112682934*z^2-32345036*n^4-54664538*n^3
+1149084*n^8*z^2-16917444*z-3326031*n^6+466223200*z^3*n^4-112*n^10+97335000*z^
3-578544*n^7+802740966*z^2*n^3+501150588*z^2*n^4-65617152*z*n^3+460142493*z^2*
n+807453069*z^2*n^2-48*n^10*z+56145957*z^2*n^6-2064*n^9*z+2112*z^2*n^10+74688*
z^2*n^9-55681602*z*n-79896102*z*n^2+205519773*z^2*n^5+194382768*z^3*n^5+2048*n
^10*z^3+72704*n^9*z^3+723291528*z^3*n^2-12667479*n^5-34080048*z*n^4+733073092*
z^3*n^3-11678046*n^5*z+53820960*n^6*z^3+1117824*n^8*z^3+9780096*n^7*z^3+
10105824*n^7*z^2-38232*n^8*z+404481900*z^3*n-9631386)*Sn+(n+5)*(2*n+13)*(2*n+
11)*(2*n+9)*(n+2)^2*(n+1)^4*(16*n^6+64*z^2*n^6+80*z*n^6+1728*z^2*n^5+432*n^5+
2160*n^5*z+18748*z^2*n^4+23624*z*n^4+4732*n^4+26856*n^3+104184*z^2*n^3+133632*
z*n^3+311701*z^2*n^2+83185*n^2+411698*z*n^2+475425*z^2*n+655146*z*n+133389*n+
86670+288750*z^2+421428*z)
then okay else % fi;
# (This needs several minutes.)
# Improved method that returns an operator of order 3.
GCD:=subs(n=n+1,skew_gcdex(subs(n=n-1,Q2),M,Dz,A)):
U:=collect(GCD[2],Dz,factor):
if %=
4*z^3*(z+1)*Dz^3+3*z^2*(z*n+9*z+n+5)*Dz^2-z*(3*z*n-31*z+6*z*n^2-7*n-9-2*n^2)*
Dz+n^3+3*n^2+3*n+1-24*z*n-4*z-5*z*n^3-21*z*n^2
then okay else % fi;
# We reduce U&*P/GCD[1] modulo M.
PR:=collect(skew_product(U,P2,A),Dz,factor):
PDIV:=skew_pdiv(PR,M,Dz,A):
# Therefore, H=Sn is
R:=collect(PDIV[3]/PDIV[1]/GCD[1],Dz,factor):
if %=
12*(z+1)*z^3/(n+1)^3*Dz^3+4*z^2*(2*z*n+2*n+14*z+11)/(n+1)^3*Dz^2-4*z*(5*z*n^2-
n^2+2*z*n-4*n-9*z-6)/(n+1)^3*Dz-(16*z*n-n-1+4*z)/(n+1)
then okay else % fi;
# (Fraction-free) Gaussian elimination:
T[1]:=[1,1]:
T[Sn]:=[numer(R),denom(R)]:
T[Sn^2]:=[skew_product(subs(n=n+1,%[1]),numer(R),A),subs(n=n+1,%[2])*denom(R)]:
T[Sn^3]:=[skew_product(subs(n=n+1,%[1]),numer(R),A),subs(n=n+1,%[2])*denom(R)]:
T[Sn^4]:=[skew_product(subs(n=n+1,%[1]),numer(R),A),subs(n=n+1,%[2])*denom(R)]:
skew_pdiv(T[Sn^2][1],M,Dz,A):
T[Sn^2]:=[%[3],T[Sn^2][2]*%[1]]:
skew_pdiv(T[Sn^3][1],M,Dz,A):
T[Sn^3]:=[%[3],T[Sn^3][2]*%[1]]:
skew_pdiv(T[Sn^4][1],M,Dz,A):
T[Sn^4]:=[%[3],T[Sn^4][2]*%[1]]:
Z:=collect(add(eta[i]*T[Sn^i][1]/T[Sn^i][2],i=0..4),Dz,numer@normal):
SOL:=solve({coeffs(Z,Dz)},{seq(eta[i],i=0..4)}):
# The contiguity relation of order 4 is:
collect(primpart(subs(SOL,add(eta[i]*Sn^i,i=0..4)),Sn),Sn,factor):
if %=
(n+3)*(2*n+3)*(n+4)^3*(16*z*n^2+4*n^2+64*z*n+16*n+63*z+15)*Sn^4+(2*n+3)*(n+3)*
(2*n+7)*(-8*n^4+256*z^2*n^4+32*z*n^4-88*n^3+352*z*n^3+2816*z^2*n^3+1418*z*n^2+
11344*z^2*n^2-350*n^2+19752*z^2*n+2445*z*n-591*n-354+12516*z^2+1482*z)*Sn^3+(2
*n+5)*(864*z*n^6+10735*n+11997*n^2+745500*z^2+2194*n^4+6940*n^3+151522*z+24*n^
6+377600*z^3*n^4+764400*z^3+1210240*z^2*n^3+377024*z^2*n^4+253540*z*n^3+
1978400*z^2*n+2141280*z^2*n^2+4096*z^2*n^6+407275*z*n+445305*z*n^2+61440*z^2*n
^5+61440*z^3*n^5+2162304*z^3*n^2+360*n^5+79354*z*n^4+1216000*z^3*n^3+12960*n^5
*z+4096*n^6*z^3+2011520*z^3*n+3886)*Sn^2+(2*n+3)*(n+2)*(2*n+7)*(32*z*n^4-8*n^4
+256*z^2*n^4-72*n^3+288*z*n^3+2304*z^2*n^3+7504*z^2*n^2+938*z*n^2-230*n^2-309*
n+10488*z^2*n+1335*z*n-149+5356*z^2+707*z)*Sn+(2*n+7)*(n+2)*(n+1)^3*(16*z*n^2+
4*n^2+24*n+96*z*n+143*z+35)
then okay else % fi;
h:='h':

# Section 1.4.4. Sylvester's dialytic elimination
A:=shift_algebra([Sn,n],[Sm,m],[comm,alpha],[comm,x],polynom=m):
(-1)^m*GAMMA(alpha+n-m)/m!/(n-2*m)!*(2*x)^(n-2*m):
numer(normal([Sn-subs(n=n+1,%)/%,Sm-subs(m=m+1,%)/%],expanded)):
skew_elim(op(%),m,A):
if cmp(%,
2*x*Sn*Sm*n+2*x*Sm*Sn+2*x*Sn*alpha*Sm-n-Sn^2*Sm*n-2*Sm*Sn^2-2*alpha
) then okay else % fi;

# Section 1.5.
# Jacobi polynomials
A:=skew_algebra(comm=[a,b],shift=[Sn,n],diff=[Dx,x]):
G:=[2*(n+2)*(n+a+b+2)*(2*n+a+b+2)*Sn^2
        -((2*n+a+b+3)*(a^2-b^2)+(2*n+a+b+2)
            *(2*n+a+b+3)*(2*n+a+b+4)*x)*Sn
        +2*(n+a+1)*(n+b+1)*(2*n+a+b+4),
    (2*n+a+b+2)*(1-x^2)*Dx*Sn-(n+1)
        *(a-b-(2*n+a+b+2)*x)*Sn-2*(n+a+1)*(n+b+1)]:
T:=MonomialOrder(A,plex(Sn,Dx)):
remove(has,Basis(G,T),Sn):
if %=[Dx^2*x^2+Dx*a*x+Dx*b*x+2*Dx*x-n*a+Dx*a-Dx^2-n-n*b-Dx*b-n^2]
then okay else % fi;
# Counter-example
A:=skew_algebra(comm=u,user=[Dx,x,proc(p,n) p end,
proc(p,n) local q;
    q:=p; to n do q:=diff(q,x)-u^2*diff(q,u) od; q
end]):
G:={Dx-u}:
u*Dx:
%+skew_product(Dx,G[1],A):
%+skew_product(u,G[1],A):
%+skew_product(Dx,G[1],A):
%+skew_product(u,G[1],A):
%+skew_product(Dx,G[1],A):
%+skew_product(u,G[1],A):
%+skew_product(Dx,G[1],A):
%+skew_product(u,G[1],A):
if %=4*Dx^2+u*Dx then okay else % fi;
# BUG: IN THE PAPER: p[2n+1]=u^2+(n+1)Dx^2

# Section 2.2.2. Example of addition of partial finite functions
# With rectangular systems.
A:=skew_algebra(diff=[Dx,x],comm={mu,nu,y}):
T:=MonomialOrder(A,tdeg(Dx)):
collect(dfinite_add([[[Dx-mu],T],[[x^2*Dx^2+x*Dx+x^2-mu^2],T]],T),Dx,factor):
if normal(%-
[x^2*(-mu^2+x^2+x^2*mu^2+x*mu)*Dx^3-x*(3*mu^2+x^3*mu-2*x*mu-mu^3*x+x^3*mu^3-x^
2)*Dx^2+(x^4-4*x^2*mu^2-x^3*mu^3+mu^4-mu^2-x^2*mu^4+x^4*mu^2-x^2)*Dx-mu*(-3*mu
^3*x+x^3*mu-2*x^2*mu^2-x^2+mu^4+x^4*mu^2-x^2*mu^4+x^4-mu^2)]
)=[0] then okay else % fi;
A:=skew_algebra(diff=[Dy,y],comm={mu,nu,x}):
T:=MonomialOrder(A,tdeg(Dy)):
collect(dfinite_add([[[Dy-nu],T],[[y^2*Dy^2+y*Dy+y^2-nu^2],T]],T),Dy,factor):
if map(A["normalizer"],%-
[y^2*(-nu^2+y^2+y^2*nu^2+y*nu)*Dy^3-y*(-nu^3*y+y^3*nu^3-2*y*nu+y^3*nu-y^2+3*nu
^2)*Dy^2+(-nu^2+y^4*nu^2-y^2*nu^4+y^4-y^3*nu^3-y^2+nu^4-4*y^2*nu^2)*Dy-nu*(-y^
2-nu^2-2*y^2*nu^2-3*nu^3*y+y^4-y^2*nu^4+y^4*nu^2+nu^4+y^3*nu)]
)=[0] then okay else % fi;
# Using the FGLM algorithm:
A:=skew_algebra(diff=[Dx,x],diff=[Dy,y],comm={mu,nu}):
T:=MonomialOrder(A,tdeg(Dx,Dy)):
GL[f]:=Basis([Dx-mu,Dy-nu],T):
GL[g]:=Basis([x^2*Dx^2+x*Dx+x^2-mu^2,y^2*Dy^2+y*Dy+y^2-nu^2],T):
collect(dfinite_add([[GL[f],T],[GL[g],T]],T),{Dx,Dy},distributed,factor):
# For some reason, dfinite_add no longer returns a Groebner basis.
Basis(%, T) :
if map(A["normalizer"],%-
[-y^2*nu^2*mu^2+y^2*nu^2*x^2-x*mu*y^2-x^2*mu^2*y^2+x*nu^2*mu+x^2*mu^2*nu^2+y*
nu*x^2-y*nu*mu^2+x*(-nu^2+y^2+y^2*nu^2+y*nu)*Dx-y*(x^2*mu^2+x*mu-mu^2+x^2)*Dy-
y^2*(x^2*mu^2+x*mu-mu^2+x^2)*Dy^2+x^2*(-nu^2+y^2+y^2*nu^2+y*nu)*Dx^2, -nu*(-y^
2*nu^4-y^2+y^4*nu^2-nu^2+nu^4+y^3*nu-2*y^2*nu^2+y^4-3*nu^3*y)+(-nu^2+y^4*nu^2-
y^2*nu^4+y^4-y^3*nu^3-y^2+nu^4-4*y^2*nu^2)*Dy-y*(-nu^3*y+y^3*nu^3-2*y*nu+y^3*
nu-y^2+3*nu^2)*Dy^2+y^2*(-nu^2+y^2+y^2*nu^2+y*nu)*Dy^3, -mu*(y-nu)*(y+nu)+(y-
nu)*(y+nu)*Dx-mu*y*Dy+Dx*y^2*Dy^2-mu*y^2*Dy^2+Dx*y*Dy]
)=[0,0,0] then okay else % fi;
# The method by intersection of ideals is as follows.
A:=diff_algebra([Dx,x],[Dy,y],[comm,mu],[comm,nu],[comm,t],polynom=t):
T:=MonomialOrder(A,lexdeg([t],[Dx,Dy])):
G:=[t*(Dx-mu),t*(Dy-nu),(1-t)*(x^2*Dx^2+x*Dx+x^2-mu^2),
    (1-t)*(y^2*Dy^2+y*Dy+y^2-nu^2)]:
GB:=Basis(G,T):
collect(remove(has,GB,t),{Dx,Dy},distributed,factor):
if map(A["normalizer"],%-
[-y^2*nu^2*mu^2+y^2*nu^2*x^2-x*mu*y^2-x^2*mu^2*y^2+x*nu^2*mu+x^2*mu^2*nu^2+y*
nu*x^2-y*nu*mu^2+x*(-nu^2+y^2+y^2*nu^2+y*nu)*Dx-y*(x^2*mu^2+x*mu-mu^2+x^2)*Dy-
y^2*(x^2*mu^2+x*mu-mu^2+x^2)*Dy^2+x^2*(-nu^2+y^2+y^2*nu^2+y*nu)*Dx^2, -nu*(-y^
2-nu^2-2*y^2*nu^2-3*y*nu^3+y^4-y^2*nu^4+y^4*nu^2+nu^4+y^3*nu)+(-y^2-nu^2+y^4-y
^3*nu^3+y^4*nu^2-y^2*nu^4+nu^4-4*y^2*nu^2)*Dy-y*(-y^2+y^3*nu+y^3*nu^3-y*nu^3-2
*y*nu+3*nu^2)*Dy^2+y^2*(-nu^2+y^2+y^2*nu^2+y*nu)*Dy^3, -mu*(y-nu)*(y+nu)+(y-nu
)*(y+nu)*Dx-mu*y*Dy+Dx*y^2*Dy^2-mu*y^2*Dy^2+Dx*y*Dy]
)=[0,0,0] then okay else % fi;

# Section 2.2.4. Cassini's identity
pol_to_sys(h(n)=f(n+2)*f(n)-f(n+1)^2,{[f(n),{f(n+2)-f(n+1)-f(n)}]}):
if %={h(n)+h(n+1)} then okay else % fi;
# Considering the shifts of the Fibonacci sequence as independent
# functions increases the order of the result.
pol_to_sys(h(n)=ssf(n)*f(n)-sf(n)^2,{
    [f(n),{f(n+2)-f(n+1)-f(n)}],
    [sf(n),{sf(n+2)-sf(n+1)-sf(n)}],
    [ssf(n),{ssf(n+2)-ssf(n+1)-ssf(n)}]}):
if %={h(n)-2*h(n+1)+h(n+3)-2*h(n+2)} then okay else % fi;

# Section 3.1. Indefinite integral
f:=1/(1+x*y+y^2)^2:
A:=diff_algebra([Dx,x],[Dy,y]):
G:=hypergeom_to_dfinite(f,A):
# BUG: IN THE PAPER, 2x+2y INSTEAD of 2x+4y!
p[x]:=op(select(has,G,Dx)):
p[y]:=op(select(has,G,Dy)):
A:=diff_algebra([Dx,x],[Dy,y],polynom=y):
T:=MonomialOrder(A,lexdeg([y],[Dx,Dy])):
GB:=Basis(G,T):
P:=op(remove(has,GB,y)):
if %=4*Dx*x^2+4*x*Dx*Dy-Dy*x^3*Dx-2*Dy*x^2-4*x*Dx^2+x^3*Dx^2-Dy^2*x+4*Dx-2*Dy
then okay else % fi;
BB:=collect(coeff(P,Dy,0),Dx,factor):
AA:=collect(normal((P-BB)/Dy),{Dx,Dy},factor):
A:=diff_algebra([Dx,x],[Dy,y],comm={t,u,v,w},polynom=t):
T:=MonomialOrder(A,lexdeg([t],[Dx,Dy])):
# BUG: IN THE PAPER GROEBNER BASES FOR MODULES SHOULD BE USED!
# Until Maple10 included, this results in GB<>[1], and the rest is correct.
# After fixing a misuse of the criterion on coprime leading monomials, the
# following GB is [1], which one confirms by hand.  Therefore, our article
# is wrong in not introducing Groebner bases for modules at this point.
GB:=Basis({u-t*AA,v-t*p[x],w-t*p[y]},T):
if GB=[1] then okay else GB end if;
A:=diff_algebra([Dx,x],[Dy,y],comm={t,u,v,w},polynom={t,u,v,w}):
T:=MonomialOrder(A,lexdeg([t],[Dx,Dy],[u,v,w]),[t,u,v,w]):
GB:=Basis({u-t*AA,v-t*p[x],w-t*p[y]},T):
new:=collect(map(primpart,map(skew_product,map(coeff,remove(has,GB,t),u,1),
    BB,A),{Dx,Dy}),{Dx,Dy},distributed,factor):
if %=
[4*y*(1+x^2)*(x^3*y+4*y^2*x^2+4*x^2+16*x*y+4*y^2+4)*Dx+4*(1+x^2)*(1+x*y+y^2)*(
3*x*y+1+y^2+y^2*x^2)*Dx*Dy+x*y*(x-2)*(x+2)*(x^3*y+4*y^2*x^2+4*x^2+16*x*y+4*y^2
+4)*Dx^2+x*(x-2)*(x+2)*(1+x*y+y^2)*(3*x*y+1+y^2+y^2*x^2)*Dx^2*Dy, 0, (12*y^3*x
^3+48*y^2*x^2+36*x*y^3+32*x*y+32*y^2+8)*Dx+x*(8*y^3*x^3+5*y^4*x^2+32*y^2*x^2+
24*x*y^3+28*x*y+15*y^4-2*y^2+7)*Dx^2+(x-2)*(x+2)*(1+x*y+y^2)*(3*x*y+1+y^2+y^2*
x^2)*Dx^3]
then okay else % fi;
A:=diff_algebra([Dx,x],[Dy,y]):
T:=MonomialOrder(A,tdeg(Dx,Dy)):
GB:=Basis({op(new),p[x]*Dy,p[y]*Dy},T):
collect(GB,{Dx,Dy},distributed,factor):
if %=
[(4*y+2*x)*Dy+(1+x*y+y^2)*Dy^2, 2*y*Dy+(1+x*y+y^2)*Dx*Dy, 4*(x^2+1)*(1+x*y+y^2
)*Dx+(-6*x*y-2-2*y^2-2*y^2*x^2)*Dy+x*(x-2)*(x+2)*(1+x*y+y^2)*Dx^2]
then okay else % fi;

if false then
# Section 3.2. Example of creative telescoping by Groebner bases
A:=skew_algebra(comm=[a,b],shift=[Sn,n],diff=[Dx,x],diff=[Dy,y],polynom=n):
G:=[2*(n+2)*(n+a+b+2)*(2*n+a+b+2)*Sn^2
        -y*(2*n+a+b+3)*(a^2-b^2+4*x*n^2+4*x*n*a+4*x*n*b
            +12*x*n+x*a^2+2*x*a*b+6*x*a+x*b^2+6*x*b+8*x)*Sn
        +2*(n+a+1)*(n+b+1)*(2*n+a+b+4)*y^2,
    -2*(n+a+1)*(n+b+1)*y+(n+1)*(-a+b+2*x*n+x*a+x*b+2*x)*Sn
        -(x-1)*(x+1)*(2*n+a+b+2)*Dx*Sn,
    n*(n+a+b+1)+(b-a-x*a-x*b-2*x)*Dx-(x-1)*(x+1)*Dx^2,
    y*Dy-n]:
T:=MonomialOrder(A,lexdeg([n],[Sn,Dx,Dy])):
GB:=Basis(G,T):
CT:=collect(subs(Sn=1,remove(has,GB,n)),[Dx,Dy],distributed,factor):
# Rectangular system.
A:=diff_algebra(comm=[a,b],[Dx,x],[Dy,y]):
T:=MonomialOrder(A,plex(Dx,Dy)):
GB:=Basis(CT,T):
collect(op(remove(has,GB,Dx)),Dy,factor):
if %=
a^2-b^2+a^3-b^3-a*b^2+b*a^2+6*x*a*b+2*x*b+3*x*a^2+3*x*b^2+2*x*a-3*y*a*b^2-3*y*
b^2+x*a^2*y*b+x*a^2*y-3*y*a^2*b-3*y*a^2-x*b^2*y*a+2*(a+b-y*b+y*a)*y*(-y^2+2*x*
y-1)*Dy^2+(-2*a-2*b-6*b*x*y^2+6*a*x*y^2-2*a^2-2*b^2+2*y^3*b^2-2*y^3*a^2-4*a*b+
4*x*a^2*y^2-4*x*b^2*y^2+8*x*y*a*b+6*b*y^3-6*a*y^3+2*y*b^2+4*x*a^2*y-2*y*a^2-8*
y^2*a-8*y^2*b-2*y^2*a^2-2*y^2*b^2-4*y^2*a*b+4*x*b^2*y+10*y*x*b+10*y*x*a)*Dy-4*
y*a-4*y*b-2*y^2*a+2*y^2*b-2*y^2*a^2+2*y^2*b^2+2*y^2*a*b^2-2*y^2*b*a^2-6*y*a*b-
x*b^2*y+y*a^3+x*b^3+y*b^3-y*b^3*x+y*a^3*x+x*a^3+3*x*b^2*a+3*x*a^2*b
then okay else % fi;
T:=MonomialOrder(A,plex(Dy,Dx)):
GB:=Basis(CT,T):
collect(op(remove(has,GB,Dy)),Dx,factor):
if %=
2*(x-1)*(x+1)*(-y^2+2*x*y-1)*(-y*x*b+y*b+y*x*a+y*a+b-x*b-a-x*a)*Dx^2+(2*x^2*y^
3*b-2*x^2*y^3*a+2*a*x^2+2*b*x^2-10*x^3*y*b+10*x^3*y^2*a-10*x^3*y*a+2*a-10*x^3*
y^2*b-4*x*y^3*b-4*x*y^3*a+2*b-2*b*x*y^2+2*a*x*y^2+2*a^2+2*b^2+2*y^3*b^2-2*y^3*
a^2+16*y^2*x^2*a+16*y^2*x^2*b-4*a*b+4*x^2*a*b-4*x*b^2*y^3-4*x*b+8*x*a^2*y^2-8*
x*b^2*y^2+4*x*a^2+8*x*y*a*b+2*b*y^3-2*a*y^3-4*x*b^2+4*x*a+2*y*b^2-8*x*a^2*y-2*
y*a^2+4*y*a-4*y*b-4*y^2*a-4*y^2*b+2*y^2*a^2+2*y^2*b^2-4*y^2*a*b-8*x*b^2*y-16*x
^2*y*a-10*x^2*y*a^2+10*x^2*y*b^2+16*x^2*y*b+4*y^2*b*x^2*a-4*y*x^3*b^2-8*y*x^3*
b*a-4*y^2*x^3*b^2+4*y^2*x^3*a^2-2*y*x*b-2*y*x*a+10*y^2*x^2*b^2+10*y^2*x^2*a^2-\
4*y*x^3*a^2+2*x^2*b^2+2*x^2*a^2-4*x*a^2*y^3+2*y^3*x^2*b^2-2*y^3*x^2*a^2)*Dx+y*
(-2*a*x^2-2*b*x^2-2*a-2*b-3*a^2-3*b^2+2*x*y^2*a*b^2-2*x*y^2*b*a^2-a^3-b^3+a*b^
2+b*a^2+2*a*b-6*x^2*a*b+4*x*b-6*x*a^2+8*x*y*a*b+6*x*b^2-4*x*a-3*y*a*b^2-3*y*b^
2+4*x*a^2*y*b+6*x*a^2*y+3*y*a^2*b+3*y*a^2+4*x*b^2*y*a+2*y*a-2*y*b-2*y^2*a*b^2-\
2*y^2*b*a^2-4*y^2*a*b+6*x*b^2*y-x^2*b^3-3*b*x^2*a^2-3*x^2*b^2*a+2*x^2*y*a+3*x^
2*y*a^2-3*x^2*y*b^2-x^2*y*b^3-x^2*b^2*y*a-x^2*a^3-2*x^2*y*b+y*a^3+x^2*y*a^3+2*
x*b^3-y*b^3+2*y*b^3*x+2*y*a^3*x-2*x*a^3+2*x*b^2*a-2*x*a^2*b+b*x^2*y*a^2+4*y*x*
b+4*y*x*a-3*x^2*b^2-3*x^2*a^2)
then okay else % fi;
# Verifying the solution.
R:=sqrt(1-2*x*y+y^2):
P:=1/(R*(1-y+R)^a*(1+y+R)^b):
map(simplify,map(applyopr,CT,P,A)):
if %=[0,0,0,0,0] then okay else % fi;
end if :

# Section 3.3. Extension of Takayama's algorithm for definite integral
# to definite anti-partial
A_rat:=skew_algebra(comm={a,b},shift=[Sn,n],diff=[Dx,x],diff=[Dy,y]):
A_poly:=skew_algebra(comm={a,b,n},diff=[Dx,x],diff=[Dy,y],polynom=n):
T_poly:=MonomialOrder(A_poly,lexdeg([n],[Dx,Dy]),[n]):
G:=[2*(n+2)*(n+a+b+2)*(2*n+a+b+2)*Sn^2
        -y*(2*n+a+b+3)*(a^2-b^2+4*x*n^2+4*x*n*a+4*x*n*b
            +12*x*n+x*a^2+2*x*a*b+6*x*a+x*b^2+6*x*b+8*x)*Sn
        +2*(n+a+1)*(n+b+1)*(2*n+a+b+4)*y^2,
    -2*(n+a+1)*(n+b+1)*y+(n+1)*(-a+b+2*x*n+x*a+x*b+2*x)*Sn
        -(x-1)*(x+1)*(2*n+a+b+2)*Dx*Sn,
    n*(n+a+b+1)+(b-a-x*a-x*b-2*x)*Dx-(x-1)*(x+1)*Dx^2,
    y*Dy-n]:
holon_defsum(G,A_rat,[n],T_poly):
map(collect,%,{Dx,Dy},distributed,factor):
if %=
[2*y*(1+b)*(1+a)+(x-1)*(x+1)*(a+b)*Dx-y*(-2*y*a-6*y-2*y*b-a+2*x+b+x*b+x*a)*Dy-\
2*y^2*(-y+x)*Dy^2+2*y*(x-1)*(x+1)*Dx*Dy, (-b+a+x*a+x*b+2*x)*Dx-y*(2+b+a)*Dy-y^
2*Dy^2+(x-1)*(x+1)*Dx^2, 2*y*(1+b)*(1+a)*(-y*a-y*b-6*y+2*x*a+a+2*x*b-b+2*x)-(x
-1)*(x+1)*(y*a^2-b^2-2*y*a*b-4*y+y*b^2+a^2)*Dx+y*(-52*y^2-26*y^2*a-26*y^2*b-8*
y^2*a*b-2*y^2*a^2-2*y^2*b^2+5*x*a^2*y+32*y*x*a-y*b^2+40*x*y+32*y*x*b+14*x*y*a*
b+5*x*b^2*y+y*a^2-6*a*b-6*b+x*a^2-4-x*b^2-a^2-6*a-b^2)*Dy+2*y^2*(-3*y^2*b-16*y
^2-3*y^2*a+6*y*x*b+22*x*y+6*y*x*a-3*b-6-3*a)*Dy^2+4*y^3*(-y^2+2*x*y-1)*Dy^3]
then okay else % fi;

# Section 3.4.1. An identity between Franel and Apery numbers
# Operator for the left-hand side.
A_rat:=shift_algebra([Sn,n],[Sk,k]):
A_poly:=shift_algebra([Sn,n],comm=k,polynom=k):
T_poly:=MonomialOrder(A_poly,lexdeg([k],[Sn]),[k]):
hypergeom_to_dfinite(binomial(n,k)^2*binomial(n+k,k)^2,A_rat):
collect(op(holon_defsum(%,A_rat,[k],T_poly)),Sn,factor):
if %=(n+2)^3*Sn^2-(2*n+3)*(17*n^2+51*n+39)*Sn+(n+1)^3 then okay else % fi;
# Operator for the right-hand side.
B_rat:=shift_algebra([Sk,k],[Sj,j]):
B_poly:=shift_algebra([Sk,k],comm=j,polynom=j):
U_poly:=MonomialOrder(B_poly,lexdeg([j],[Sk]),[j]):
hypergeom_to_dfinite(binomial(k,j)^3,B_rat):
holon_defsum(%,B_rat,[j],U_poly):
T_rat:=MonomialOrder(A_rat,tdeg(Sn,Sk)):
[Basis([op(%%),Sn-1],T_rat),T_rat]:
[Basis(hypergeom_to_dfinite(binomial(n,k)*binomial(n+k,k),A_rat),
    T_rat),T_rat]:
collect(op(holon_defsum(dfinite_mul([%%,%],T_rat),A_rat,[k],T_poly)),
    Sn,factor):
if %=
(n+2)^3*Sn^2-(2*n+3)*(17*n^2+51*n+39)*Sn+(n+1)^3
then okay else % fi;

# Section 3.4.2. A Rogers-Ramanujan identity
A_rat:=skew_algebra(comm=q,qdilat=[Sn,qn,q],qdilat=[Sk,qk,q]):
A_poly:=skew_algebra(comm={q,qk},qdilat=[Sn,qn,q],polynom=qk):
T_poly:=MonomialOrder(A_poly,lexdeg([qk],[Sn]),{qk}):
h:=q^(k^2)/qfactorial(q,k)/qfactorial(q,n-k):
G:=collect(map(primpart,subs({q^n=qn,q^k=qk},normal(expand(expand(
    [Sn-subs(n=n+1,h)/h,Sk-subs(k=k+1,h)/h])))),
    {Sn,Sk}),{Sn,Sk},factor):
# Operator of order 2 for the left-hand side.
collect(op(holon_defqsum(G,A_rat,[qk],T_poly)),Sn,factor):
if %=(-1+q^2*qn)*Sn^2+(q^3*qn^2-q^2*qn+q+1)*Sn-q
then okay else % fi;
h:=(-1)^k*q^((5*k^2-k)/2)/qfactorial(q,n-k)/qfactorial(q,n+k):
G:=collect(map(primpart,subs({q^n=qn,q^k=qk},normal(combine(expand(
    [Sn-subs(n=n+1,h)/h,Sk-subs(k=k+1,h)/h]),power),expanded)),
    {Sn,Sk}),{Sn,Sk},factor):
# Operator of order 5 for the right-hand side.
collect(op(holon_defqsum(G,A_rat,[qk],T_poly)),Sn,factor):
if %=
(q^5*qn+1)*(q^5*qn-1)*(q^9*qn^2-1)*Sn^5+(q^10*qn^2+q^12*qn^2-q^4+q^11*qn^2+q^
23*qn^5-q^2+q^22*qn^5-1-q^3-q)*Sn^4+q*(qn^2*q^8+q+2*q^2+1+q^5+q^6+2*q^4+2*q^3+
q^24*qn^6+q^10*qn^2+q^9*qn^2+q^17*qn^4+q^16*qn^4)*Sn^3-q^3*(1+2*q^2+q+2*qn^2*q
^8+q^7*qn^2+2*q^4+q^6+q^5+q^16*qn^4+q^15*qn^4+q^14*qn^4+2*q^3+q^11*qn^2+q^10*
qn^2+2*q^9*qn^2)*Sn^2+q^6*(q^4+q^6*qn^2+1+q+q^3+q^2+qn^2*q^8+q^7*qn^2)*Sn-q^10
then okay else % fi;
# Creative symmetrizing:
h:=h*(1+q^k)/2:
G:=collect(map(primpart,subs({q^n=qn,q^k=qk},normal(combine(expand(
    [Sn-subs(n=n+1,h)/h,Sk-subs(k=k+1,h)/h]),power),expanded)),
    {Sn,Sk}),{Sn,Sk},factor):
# Operator of order 3 for the right-hand side.
collect(op(holon_defqsum(G,A_rat,[qk],T_poly)),Sn,factor):
if %=
(q^3*qn+1)*(q^2*qn+1)*(q^3*qn-1)*Sn^3+(q^10*qn^4+q^7*qn^3+q^5*qn^2+q^3*qn+q^2*
qn+q^2+q+1)*Sn^2-q*(q^5*qn^2+q^4*qn^2+q^2+q^2*qn+q+1)*Sn+q^3
then okay else % fi;

# Section 3.4.3. q-Dixon identity
h:=(-1)^k*q^(k*(3*k+1)/2)
    *qbinomial(q,a+b,a+k)*qbinomial(q,a+c,c+k)*qbinomial(q,b+c,b+k):
G:=subs({q^a=qa,q^b=qb,q^c=qc,q^k=qk},
collect(map(primpart,subs({q^n=qn,q^k=qk},normal(combine(expand([
    Sa-subs(a=a+1,h)/h,
    Sb-subs(b=b+1,h)/h,
    Sc-subs(c=c+1,h)/h,
    Sk-subs(k=k+1,h)/h
]),power),expanded)),{Sa,Sb,Sc,Sk}),{Sa,Sb,Sc,Sk},factor)):
if zip(cmp,%,[
(q*qa-qk)*(q*qa*qk-1)*Sa-qk*(-1+qc*q*qa)*(q*qa*qb-1),
(q*qb*qk-1)*(qb*q-qk)*Sb-qk*(qb*q*qc-1)*(q*qa*qb-1),
(q*qc*qk-1)*(qc*q-qk)*Sc-qk*(qb*q*qc-1)*(-1+qc*q*qa),
(q*qc*qk-1)*(q*qb*qk-1)*(q*qa*qk-1)*Sk-q^2*(qk-qc)*(qk-qb)*(qk-qa)
])=[true$4] then okay else % fi;
A_rat:=skew_algebra(qdilat=[Sa,qa,q],qdilat=[Sb,qb,q],qdilat=[Sc,qc,q],
    qdilat=[Sk,qk,q]):
A_poly:=skew_algebra(qdilat=[Sa,qa,q],qdilat=[Sb,qb,q],qdilat=[Sc,qc,q],
    comm=qk,polynom=qk):
T_poly:=MonomialOrder(A_poly,lexdeg([qk],[Sa,Sb,Sc]),{qk}):
tak:=holon_defqsum(G,A_rat,[qk],T_poly):
collect(tak,{Sa,Sb,Sc},distributed,factor):
# This is to avoid non-determinism.
map(op,[remove(has,tak,Sa),remove(has,tak,Sb),remove(has,tak,Sc)]):
if zip(cmp,%,
[(-qb+qc)*Sc*Sb-qb*(q*qa*qc-1)*Sb+qc*(-1+q*qa*qb)*Sc, (-qa+qc)*Sc*Sa+qc*(-1+q*
qa*qb)*Sc-qa*(q*qb*qc-1)*Sa, (qa-qb)*Sb*Sa-qb*(q*qa*qc-1)*Sb+qa*(q*qb*qc-1)*Sa
])=[true,true,true] then okay else % fi;
# BUG: NOT THE ANNOUNCED VALUE!
# BUG: COMPUTATION OF THE NEXT ITERATION OF THE LOOP IS TOO LONG
# The end of the example is left.

# Section 4.3. The extension/contraction problem
# Binomial coefficients
u:=binomial(n,k):
A:=shift_algebra([Sn,n],[Sk,k]):
G:=hypergeom_to_dfinite(u,A):
P:=op(select(has,G,Sn)):
Q:=op(select(has,G,Sk)):
R:=Sn*Sk-Sk-1:
A:=shift_algebra([Sn,n],[Sk,k],polynom={n,k}):
T:=MonomialOrder(A,tdeg(Sn,Sk,n,k)):
GB:=Basis(G,T):
Reduce(R,GB,T):
if %=Sk*Sn-Sk-1 then okay else % fi;
Reduce((n+1)*R,GB,T):
if %=0 then okay else % fi;
Reduce((k+1)*R,GB,T):
if %=0 then okay else % fi;
A:=shift_algebra([Sn,n],[Sk,k],polynom=k):
T:=MonomialOrder(A,lexdeg([k],[Sn,Sk])):
GB:=Basis(G,T):
op(remove(has,GB,k)):
if %=Sk*Sn-Sk-1 then okay else % fi;
# Diagonal
f:=1/(1-(x+y)):
F:=normal(subs({x=s,y=x/s},f)/s):
A:=diff_algebra([Ds,s],[Dx,x]):
G:=hypergeom_to_dfinite(F,A):
P:=op(select(has,G,Ds)):
Q:=op(select(has,G,Dx)):
U:=Ds^2+(4*x-1)*Dx^2+6*Dx:
normal(applyopr(U,F,A)):
if %=0 then okay else % fi;
A:=diff_algebra([Ds,s],[Dx,x],polynom={s,x}):
T:=MonomialOrder(A,tdeg(Ds,Dx,s,x)):
Reduce(U,Basis(G,T),T):
if %=Ds^2+4*x*Dx^2-Dx^2+6*Dx then okay else % fi;
R:=(s^2-s+x)*Ds*Dx+2*Ds:
# BUG: INCORRECT SIGN IN THE PAPER!
Reduce(U,Basis({P,Q,R},T),T):
if %=0 then okay else % fi;
A:=diff_algebra([Ds,s],[Dx,x]):
B:=diff_algebra([Dx,x],comm=s,polynom=s):
T:=MonomialOrder(B,lexdeg([s],[Dx]),[s]):
holon_defint([P,Q,R],A,[s],T):
if %=[2+4*Dx*x-Dx] then okay else % fi;
